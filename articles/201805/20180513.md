# レイトレーシング(12): 鏡面反射と屈折

## 0. 以前の記事の訂正

  第8回の記事で完全拡散反射の場合のBRDF($f_r$)を下記のように示した。

  \[
  f_r = \frac{(拡散反射)}{2\pi}
  \]

  が、間違いだった。shocker-0x15 さんからご指摘をいただきました。
  ありがとうございます。正しい式は以下。

  \[
  f_r = \frac{(拡散反射)}{\pi}
  \]

  これにより、得られる輝度が全体的に約半分になるが、輝度を画面の
  色に変換するところで調整してやればいいので大きな問題はなかった。
  やれやれ。

## 1. 今回の改善

  今回は例トレーシング回の最終回ということで、やっと目標だった集光
  模様の実現に取り組むことにする。また、ついでに球以外の形状の
  サポート、設定ファイルの対応もやってみた。

### -1. Material型

  比較表

まず最初に`Material`型の拡張について説明したい。`Material`型は
物体の物性や模様を表すために定義した型だ。前回までは単純な
完全拡散面を想定していたためパラメータは少ししかなかった（コード
自体には書いていても使っていないものもあった）。鏡面反射・屈折を
サポートするにあたりいくつかのパラメータを追加したし、実際に
値を使うようにコードを拡張した。下表に従来と今回の対応を示す。

|parameter    |型    |説明|前回版|今回|
|:-:|:-:|:-:|:-:|:-:|
|emittance    |Radiance|自己発光強度|○|○|
|reflectance  |Color   |拡散反射率(≒物体色?)|○|○|
|specularRefl |Color   |鏡面反射率(金属反射)|-|○|
|transmittance|Color   |透過率|-|-|
|ior          |Color   |屈折率|-|○|
|diffuseness  |Double  |拡散度※1|○|○|
|metalness    |Double  |金属性※2|-|○|
|smoothness   |Double  |平滑度|-|-|

> ※1: 拡散反射と鏡面反射のあり合いを表す。1.0だと完全拡散反射、0.0
  だと完全鏡面反射となる。鏡面反射方向からの光をどれだけ反射するか。

> ※2: 金属性と書いたが金属反射と透過の割合を表す。1.0だと完全に
  不透明で金属反射のみ、0.0だとガラスのような透明物体となる。

今回もまだ対応できていない`transmittance`は透明物質内での光の通過
割合を指定することで、色ガラスのような物体を表すため、smoothnessは
表面のざらつき具合でぼやけたハイライトなどを表すためのパラメータだ。
ぜひともこれらの実装をしたいが、今後の課題とする。

`ior`の型が`Color`になっているのは、色（光の波長）毎に屈折率が違う
場合があるため。三角プリズムによる光の分散を再現するためだ。とはいえ、
現状は赤、緑、青の3波長しか扱っていないため、いわゆる虹色にならず
紫部分は表現できない紫を加えた4波長とかにすればそれも可能になろうが
光の三原色じゃなくなるので画面上の色へどう変換するか考えないと
いけない。

各パラメータがどのように使われるかは後の節で説明する。

### -2. 鏡面反射・屈折ベクトル

  反射率の近似式、ベクトルの公式、コード


（図）

### -3. フォトン追跡

  場合分け、反射屈折方向からのフォトン書き出し、コード
  フローチャート？

鏡面反射・屈折が追加されたので、フォトン追跡もそれに合わせて
いろいろ拡張せねばなるまい。これまでは拡散面だけだったので、
その反射率によって拡散反射か吸収（追跡終了）しかなかったが、
今回は物性によりそのバリエーションが増えた。

* 拡散反射か鏡面反射か吸収か
* 反射か屈折か

この辺の場合分けを前述の`Material`の各パラメータとロシアンルーレットを
使って表現していくのだ。解り易いようにフローチャートで表そう。
まずは拡散反射だけのフローがこちら。

（拡散フロー）

コードはこちら。

（拡散コード）

一方、今回拡張したフローとコードはこちら。だいぶ複雑になっているのがわかる。

（今回フロー）

（今回こーど）

屈折をサポートしたので、最初の目的（第一回）だった「集光模様」が得られる
はずだ！というわけで、ガラス球を配置してフォトンマップを生成してみよう。



### -4. レンダリング方程式(?)

  式の新旧、コード

  例：銀＝鏡、ガラス（集光模様）

## 2. 作例

  物質の変化（石膏、サンゴ、金、プリズムガラス）
  直方体、正四面体、球2個

## 3. まとめ



※ 今回分のソースは[こちら](https://github.com/eijian/raytracer/tree/version-2.5.2.0)。
